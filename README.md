# 基于PINN的微流控芯片流场重建系统

## 项目概述

基于COMSOL模拟数据训练物理信息神经网络(PINNs)，开发微流控芯片流场稀疏重建与可视化系统。

**技术栈**: COMSOL 6.3 + DeepXDE + Python 3.9 + PyQt5

---

## 当前进度

| 阶段 | 任务 | 状态 | 完成日期 |
|------|------|------|----------|
| 阶段1 | COMSOL数据准备 | ✅ 完成 | 2025-12-24 |
| 阶段2 | PINNs模型开发 | 🔄 进行中 | - |
| 阶段3 | 可视化软件开发 | ⬜ 待开始 | - |
| 阶段4 | 部署与文档 | ⬜ 待开始 | - |

**数据状态**: 37组数据，~8.3M数据点

### 数据集详情

| 类型 | 状态 | 组数 | 数据点 | 备注 |
|------|------|------|--------|------|
| 直通道 | ✅ | 16 | ~8.0M | 完整可用 |
| T型分岔道 | ⚠️ | 9 | ~6K | 点数偏少 |
| Y型分岔道 | ✅ | 9 | ~194K | 完整可用 |
| 不同粘度 | ❌ | 3 | ~66K | U_max异常，待修复 |

---

## 待解决问题清单

### 🔴 高优先级

#### 1. T型/Y型分岔道数据质量问题

**问题描述**:
- T型分岔道只有548个数据点，而直通道有52万个点
- 数据密度差异达966倍
- 速度值异常：U_max=10 m/s（应为~0.015 m/s）

**根本原因**:
- Export节点默认导出边界数据而非域内网格数据
- Export配置中缺少"数据源选择"设置

**解决方案**:
- [ ] 在COMSOL GUI中打开 `tjunction_base.mph`
- [ ] 配置Export节点：**数据** 选择 **网格(Mesh)** 而非解数据
- [ ] 验证导出数据点数 > 10万
- [ ] 验证速度值范围合理（0 ~ 0.02 m/s）

**参考文档**: `comsol_simulation/docs/MODEL_SETUP_GUIDE.md`

---

#### 2. Y型分岔道流道形状错误

**问题描述**:
- 原Y型模型使用简单的水平矩形堆叠
- 未实现真正的Y形分岔（带角度分支）

**修复状态**:
- [x] 已更新 `create_base_models.py` 使用Polygon创建正确Y形
- [x] 已重新生成 `yjunction_base.mph`
- [ ] 待在GUI中验证几何形状
- [ ] 待设置边界条件并测试

**预期形状**:
```
    |
    | 入口
    |
  /   \
 /     \
|       |
```

---

### 🟡 中优先级

#### 3. 基准模型GUI设置

**需要完成的操作**:

| 模型文件 | 边界设置 | Export配置 | 状态 |
|---------|---------|-----------|------|
| `tjunction_base.mph` | 待设置 | 待配置 | ⬜ |
| `yjunction_base.mph` | 待设置 | 待配置 | ⬜ |

**操作步骤**:
1. 在COMSOL GUI中打开模型文件
2. 设置边界条件（入口、出口1、出口2、壁面）
3. 配置Export节点导出域内数据
4. 运行求解验证
5. 保存模型

---

#### 4. API数据生成方法优化

**当前问题**:
- `generate_extended_dataset.py` 中Export配置不完整
- 网格数据集创建方法未找到正确API

**待探索方案**:
- [ ] 方案A: 使用GUI预设Export，API只修改参数
- [ ] 方案B: 研究COMSOL Java API的Mesh数据集配置
- [ ] 方案C: 使用Cut Point 2D数据集替代Export

---

### 📊 问题统计

| 问题类型 | 数量 | 状态 |
|---------|------|------|
| 数据质量问题 | 2 | 🔄 修复中 |
| 模型形状问题 | 1 | ✅ 已修复 |
| GUI设置待完成 | 2 | ⬜ 待处理 |

**最近更新**: 2025-12-25

---

## 数据评估报告

### 当前数据概况

| 参数 | 当前值 |
|------|--------|
| 几何类型 | 仅直流道 |
| 通道宽度 | 150, 200, 250 μm (3档) |
| 通道长度 | 10 mm (1档) |
| 入口速度 | 0.15, 0.77, 1.54 cm/s (3档) |
| 流体密度 | 1000 kg/m³ (仅水) |
| 动力粘度 | 0.001 Pa·s (仅水) |

### 覆盖度评估

**功能覆盖度: 55%**

| 功能 | 状态 | 覆盖度 |
|------|------|--------|
| F1: 流场可视化 | ✅ | 90% |
| F2: 流体参数配置 | ❌ | 10% |
| F3: 几何建模 | ⚠️ | 30% |
| F4: 任意点查询 | ✅ | 80% |
| F5: 稀疏数据重建 | ✅ | 90% |
| F6: 特征提取 | ✅ | 80% |
| F7: 物性校准 | ❌ | 20% |
| F8: 单条件模拟 | ⚠️ | 40% |

**创新点覆盖度: 47%**

| 创新点 | 状态 | 覆盖度 |
|--------|------|--------|
| I1: 稀疏采样策略 | ❌ | 20% |
| I2: 自适应物理约束 | ⚠️ | 70% |
| I3: 轻量化推理 | ⚠️ | 50% |

### 数据扩展计划

| 优先级 | 任务 | 状态 | 备注 |
|--------|------|------|------|
| 🔴 高 | T型分岔道数据 (9组) | 🔄 API调试中 | COMSOL API调用复杂 |
| 🔴 高 | Y型分岔道数据 (9组) | ⬜ 待开始 | 需要先创建Y型模型 |
| 🔴 高 | 不同粘度数据 (3组) | 🔄 数据质量待修复 | Export方法问题 |
| 🟡 中 | 扩展通道长度 (可选) | ⬜ 待生成 | - |

**当前数据集**: 15组直通道数据 (已完成)
**建议**: 使用COMSOL GUI手动生成分岔道数据，API方法待后续优化

---

## 核心功能

| 编号 | 功能 | 描述 | 状态 |
|------|------|------|------|
| 1 | 流场可视化 | 速度场、压力场与流线分布云图可视化 | ⬜ |
| 2 | 流体参数配置 | 物性参数（密度、粘度）及边界条件配置，支持无量纲化转换 | ⬜ |
| 3 | 几何建模 | 支持直流道、T型、Y型分岔道，参数化生成 | ⬜ |
| 4 | 任意点查询 | PINN模型作为连续函数，预测任意坐标流速、压力 | ⬜ |
| 5 | 稀疏数据重建 | 导入含噪声稀疏测量数据，重建完整流场 | ⬜ |
| 6 | 特征提取 | 压力梯度、壁面剪切应力、流线曲率等参数敏感性分析 | ⬜ |
| 7 | 物性校准 | 交互式调整粘度参数，匹配实测与预测流场 | ⬜ |
| 8 | 单条件模拟 | 入口流速、雷诺数等单参数变化影响模拟 | ⬜ |

---

## 创新点

1. **面向微流控特性的稀疏采样策略**
   - 针对二维微流控芯片层流特性
   - 关键点采样：流道拐角、分岔处等特征位置
   - 少量测量点实现全流场高精度重建

2. **自适应物理约束增强机制**
   - 动态物理约束策略
   - 分阶段损失权重调度
   - 融合壁面无滑移条件与质量守恒定律
   - 提升稀疏噪声数据下重建鲁棒性

3. **轻量化推理验证工具**
   - 无需重复训练即可适应新工况
   - 支持参数变化：通道长度、流体粘度等
   - 快速流场预测，提升设计迭代效率

---

## 工作计划表

### 阶段1: COMSOL数据准备 ✅

| 任务 | 状态 | 完成日期 |
|------|------|----------|
| COMSOL环境配置 | ✅ | 2025-11-19 |
| 参数化模型创建 | ✅ | 2025-12-23 |
| 9组数据生成 | ✅ | 2025-12-23 |
| 数据验证与转换 | ✅ | 2025-12-23 |

### 阶段2: PINNs模型开发 (3-4周)

| 任务 | 状态 | 完成日期 |
|------|------|----------|
| DeepXDE环境配置 | ✅ | 2025-12-23 |
| 数据预处理 | ✅ | 2025-12-23 |
| N-S方程实现 | ✅ | 2025-12-23 |
| 网络架构设计 | ✅ | 2025-12-23 |
| 模型训练与调优 | ⬜ | - |
| 模型验证评估 | ⬜ | - |

### 阶段3: 可视化软件开发 (4-5周)

| 任务 | 状态 | 完成日期 |
|------|------|----------|
| Streamlit原型 | ⬜ | - |
| PyQt5桌面应用 | ⬜ | - |
| 后端集成 | ⬜ | - |
| 功能测试 | ⬜ | - |

### 阶段4: 部署与文档 (1-2周)

| 任务 | 状态 | 完成日期 |
|------|------|----------|
| 软件打包 | ⬜ | - |
| 用户文档 | ⬜ | - |

---

## 环境配置

### 1. COMSOL环境
```bash
# COMSOL 6.3 已安装: E:\COMSOL63\Multiphysics\
# Python接口 (mph)
pip install mph>=0.5.0
```

### 2. Python环境
```bash
# 创建虚拟环境
conda create -n pinns python=3.9
conda activate pinns

# 安装依赖
pip install -r requirements.txt
```

### 3. DeepXDE配置
```bash
# 选择后端并安装
pip install deepxde

# TensorFlow后端 (推荐)
pip install tensorflow>=2.13.0

# 或 PyTorch后端
pip install torch>=2.0.0
```

---

## 常用命令

### 数据处理
```bash
# 验证数据
python comsol_simulation/scripts/tests/verify_all_9_datasets.py

# 转换为HDF5
python comsol_simulation/scripts/data_processing/convert_all_to_hdf5.py
```

### PINNs训练
```bash
# 数据预处理
python pinn_training/data_preprocessing/preprocess_data.py

# 训练模型
python pinn_training/training/train_pinn.py

# 评估模型
python pinn_training/training/evaluate.py
```

### 可视化
```bash
# Streamlit原型
streamlit run visualization/streamlit_app.py

# PyQt5应用
python visualization/app.py
```

---

## 项目结构

```
PINNs/
├── comsol_simulation/       # COMSOL模拟模块 ✅
│   ├── models/              # .mph模型文件
│   ├── scripts/             # 脚本 (40个)
│   ├── data/                # 数据文件 (9组HDF5+CSV)
│   └── docs/                # 文档
├── pinn_training/           # PINNs训练模块 🔄
│   ├── data_preprocessing/  # 数据预处理
│   ├── models/              # 模型定义
│   └── training/            # 训练脚本
├── visualization/           # 可视化软件 ⬜
│   ├── gui/                 # PyQt5界面
│   └── backend/             # 后端API
├── requirements.txt         # Python依赖
└── README.md                # 本文件
```

---

## 数据集说明

### 15组参数化数据

**原有9组**:
| 文件名 | 入口速度 | 通道宽度 | Reynolds数 | 数据点 |
|--------|----------|----------|-----------|--------|
| v0.2_w150 | 0.15 cm/s | 150 μm | 0.23 | 550K |
| v0.8_w150 | 0.77 cm/s | 150 μm | 1.15 | 550K |
| v1.5_w150 | 1.54 cm/s | 150 μm | 2.31 | 550K |
| v0.2_w200 | 0.15 cm/s | 200 μm | 0.31 | 529K |
| v0.8_w200 | 0.77 cm/s | 200 μm | 1.54 | 529K |
| v1.5_w200 | 1.54 cm/s | 200 μm | 3.08 | 529K |
| v0.2_w250 | 0.15 cm/s | 250 μm | 0.39 | 468K |
| v0.8_w250 | 0.77 cm/s | 250 μm | 1.92 | 468K |
| v1.5_w250 | 1.54 cm/s | 250 μm | 3.84 | 468K |

**新增6组** (2025-12-24):
| 文件名 | 入口速度 | 通道宽度 | Reynolds数 | 数据点 |
|--------|----------|----------|-----------|--------|
| v0.4_w150 | 0.40 cm/s | 150 μm | 0.61 | 468K |
| v0.4_w200 | 0.40 cm/s | 200 μm | 0.81 | 468K |
| v0.4_w250 | 0.40 cm/s | 250 μm | 1.01 | 468K |
| v1.2_w150 | 1.20 cm/s | 150 μm | 1.83 | 468K |
| v1.2_w200 | 1.20 cm/s | 200 μm | 2.43 | 468K |
| v1.2_w250 | 1.20 cm/s | 250 μm | 3.04 | 468K |

**总计**: ~7.5M数据点，~580 MB (HDF5)

**数据格式**:
```
.h5文件结构:
├── coordinates (N×2): [x, y] 坐标
├── velocity_u (N): x方向速度
├── velocity_v (N): y方向速度
└── pressure (N): 压力
```

---

## 更新日志

### 2025-12-24 (晚上 - 深度验证)
- **数据真实性验证**
  - ✅ 直通道数据：物理特征正确（泊肃叶流抛物线分布，压力线性下降）
  - ❌ T型分岔道数据：坐标全为0（Export导出问题）
  - ❌ Y型分岔道数据：U_max=10m/s（单位问题）
  - ❌ 不同粘度数据：U_max=10m/s（单位问题）
- **问题根因分析**
  - Export导出的坐标单位是mm，需要转换为m
  - 数据解析格式与expr设置顺序不匹配
- **解决方案**
  - 已更新`generate_extended_dataset.py`修复坐标单位问题
  - 已创建`comsol_simulation/docs/COMSOL_API_GUIDE.md`API使用指南
- **待处理**
  - 重新生成T型、Y型分岔道和不同粘度数据

### 2025-12-24 (晚上)
- **修复COMSOL API材料属性设置问题**
  - 发现正确API：`physics.feature('fp1').set('mu_mat', 'userdef')`
  - 修复后成功生成T型分岔道数据（9组）和Y型分岔道数据（9组）
- **生成Y型分岔道数据集（9组）**
  - 入口速度: 0.15, 0.77, 1.54 cm/s
  - 通道宽度: 150, 200, 250 μm
  - 数据点: ~194K（Y型）
- **问题记录**:
  - T型分岔道数据点数偏少（~700点/组）
  - 不同粘度数据U_max异常（10 m/s）
  - 输出路径问题（重复comsol_simulation目录）

### 2025-12-24 (下午)
- 尝试使用COMSOL Python API生成T型分岔道和不同粘度数据
- 发现API调用复杂性问题：边界条件设置、数据提取方法
- 创建了 `generate_from_existing_models.py` 基于现有模型生成数据
- 创建了多个诊断脚本调试API：`test_inlet_api.py`, `check_study_tag.py`
- 问题记录：
  - `model.evaluate()` 返回全零数据
  - `export.getRealData()` 方法不存在
  - 修改入口速度后求解未更新解数据
- 下一步：建议使用COMSOL GUI手动生成分岔道数据，或继续调试API

### 2025-12-24 (上午)
- 使用COMSOL Python API自动生成6组参数化数据
- 通过mph库的Model.evaluate()方法成功提取数据
- 新增数据: v0.4和v1.2两种速度 × 3种宽度 = 6组
- 总数据量扩展至: ~7.5M点，~580 MB (HDF5)
- 创建诊断脚本: diagnose_physics_features.py, diagnose_base_model.py
- 修复研究名称动态检测问题

### 2025-12-23
- 完成9组参数化数据生成与验证
- 总数据量: 4.7M点，HDF5格式 ~178 MB
- 重构README.md，简化文档结构
- 配置DeepXDE环境 (v1.14.0 + TensorFlow 2.13.0)
- 完成数据预处理脚本
- 实现Navier-Stokes方程PINN模型
- 创建训练脚本 (train_pinn.py)

### 2025-11-19
- 修复COMSOL Python API连接
- 生成第一组真实数据 (528K点)
- 完成数据验证

---

## 里程碑

| 里程碑 | 目标 | 状态 |
|--------|------|------|
| M1 | COMSOL数据集 (9组) | ✅ 完成 |
| M2 | PINNs模型训练 | 🔄 进行中 |
| M3 | 可视化软件 | ⬜ 待开始 |
| M4 | 完整系统 v1.0 | ⬜ 待开始 |
